kind: pipeline
name: portfolio

steps:
- name: react-app
  image: node:17-buster
  commands:
  - npm ci
  - npm run build
  when:
    event:
      - push

- name: sonarqube
  image: aosapps/drone-sonar-plugin
  settings:
    sonar_host: 
      from_secret: SONAR_HOST
    sonar_token: 
      from_secret: SONAR_TOKEN
    branchAnalysis: true
  when:
    event: push


- name: docker
  image: plugins/docker
  volumes:
  - name: docker_sock
    path: /var/run/docker.sock
  settings:
    repo: dysnomia/elanis
    dockerfile: Dockerfile
    tags: ${DRONE_BRANCH//\//-}
    dry_run: true
    pull-image: false
  environment:
    PLUGIN_PULL_IMAGE: false
  when:
    event:
    - push

- name: discord
  pull: default
  image: appleboy/drone-discord
  settings:
    webhook_id:
      from_secret: WEBHOOK_ID
    webhook_token:
      from_secret: WEBHOOK_TOKEN
    message: >
      {{#success build.status}}
        Build **{{repo.name}}** on branch **${DRONE_BRANCH}** succeeded.
      {{else}}
        Build **{{repo.name}}** on branch **${DRONE_BRANCH}** failed.
      {{/success}}
  when:
    status: 
    - changed
    - failure
    - success

volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock