kind: pipeline
name: portfolio-dotnet

steps:
- name: docker
  image: plugins/docker
  volumes:
  - name: docker_sock
    path: /var/run/docker.sock
  settings:
    repo: dysnomia/elanis
    dockerfile: Dockerfile
    tags: ${DRONE_BRANCH}
    dry_run: true
    pull-image: false
  environment:
    PLUGIN_PULL_IMAGE: false
    SONAR_HOST: 
      from_secret: SONAR_HOST
    SONAR_TOKEN: 
      from_secret: SONAR_TOKEN
  settings:
    build_args_from_env:
      - SONAR_HOST
      - SONAR_TOKEN

  when:
    event:
    - push

- name: discord
  pull: default
  image: appleboy/drone-discord
  settings:
    webhook_id:
      from_secret: WEBHOOK_ID
    webhook_token:
      from_secret: WEBHOOK_TOKEN
    message: >
      {{#success build.status}}
        Build **{{repo.name}}** on branch **${DRONE_BRANCH}** succeeded.
      {{else}}
        Build **{{repo.name}}** on branch **${DRONE_BRANCH}** failed.
      {{/success}}
  when:
    event:
    - push
    status: 
    - changed
    - failure
    - success

volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock